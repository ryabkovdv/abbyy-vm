# Описание виртуальной машины

## Архитектура

Виртуальная машина имеет в своем распоряжении 16 32-битных регистров,
а также регистр _pc_, хранящий адрес текущей инструкции. Регистр _x0_ всегда
содержит значение 0. Память имеет побайтовую адресацию.

Изначально регистры _x0_-_x15_ инициализированы нулем,
а _pc_ – значением 0x1000.

## Вычислительные инструкции

### Инструкции регистр-константа

| 31                   16 | 15   12 | 11    8 | 7     0 |
|:-----------------------:|:-------:|:-------:|:-------:|
|        imm[15:0]        |    rs   |    rd   |  opcode |

Все инструкции производят операцию над значением в регистре _rs_
и 16-битной константой, расширенной знаком до 32 бит,
и записывают результат в регистр _rd_.

ADDI и MULI производят сложение и умножение _rs_ и _imm_.

RSUBI вычитает из _imm_ значение в _rs_.

ANDI, ORI, XORI совершают соответствующие побитовые операции.

SHLI, LSHRI, ASHRI производят побитовые сдвиги влево, логический
и арифметический сдвиг вправо значения в регистре _rs_ на количество,
записанное в нижних 5 битах константы.

### Инструкции LI и LUI

| 31                           12 | 11    8 | 7     0 |
|:-------------------------------:|:-------:|:-------:|
|            imm[19:0]            |    rd   |  opcode |

Инструкция LI записывает в регистр _rd_ значение 20-битной константы,
расширенной знаком.

Инструкция LUI записывает в верхние биты регистра _rd_
значение 20-битной константы, а в нижние – 0.

### Инструкции регистр-регистр

| 31          20 | 19   16 | 15   12 | 11    8 | 7     0 |
|:--------------:|:-------:|:-------:|:-------:|:-------:|
|  000000000000  |   rs2   |   rs1   |    rd   |  opcode |

Все инструкции производят операцию над значениями в регистрах _rs1_ и _rs2_
и записывают результат в регистр _rd_.

ADD, SUB и MUL производят сложение, вычитание и умножение _rs1_ и _rs2_.

AND, OR, XOR совершают соответствующие побитовые операции.

SHL, LSHR, ASHR производят побитовые сдвиги влево, логический
и арифметический сдвиг вправо значения в регистре _rs1_ на количество,
записанное в нижних 5 битах регистра _rs2_.

### Инструкции деления и широкого умножения

| 31     24 | 23   20 | 19   16 | 15   12 | 11    8 | 7     0 |
|:---------:|:-------:|:-------:|:-------:|:-------:|:-------:|
|  00000000 |   rs2   |   rs1   |   rd2   |   rd1   |  opcode |

Все инструкции производят операцию над значениями в регистрах _rs1_ и _rs2_
и записывают два результата в регистры _rd1_ и _rd2_.
Регистры _rd1_ и _rd2_ должны быть разными.

MULW производит 64-битное умножение значений в регистрах _rs1_ и _rs2_,
расширенных знаком, и записывает в _rd1_ нижнюю часть,
а в _rd2_ – верхнюю часть результата. MULWU совершает аналогичную операцию,
но расширяет значения источников нулем.

DIV и DIVU производят знаковое и беззнаковое деление _rs1_ на _rs2_
и записывают в _rd1_ частное, а в _rd2_ – остаток. В случае деления на 0
в _rd1_ записывается -1, а в _rd2_ – _rs1_.

## Инструкции перехода

### Инструкции безусловного перехода

| 31                           12 | 11    8 | 7     0 |
|:-------------------------------:|:-------:|:-------:|
|            off[19:0]            |    rd   |  opcode |

Инструкция JAL (jump-and-link) вычисляет новый адрес следующим образом:
к адресу следующей инструкции прибавляется 20-битное смещение,
расширенное знаком, умноженное на 4. В регистр _rd_ записывается
адрес следующей инструкции.

| 31                   16 | 15   12 | 11    8 | 7     0 |
|:-----------------------:|:-------:|:-------:|:-------:|
|        off[15:0]        |    rs   |    rd   |  opcode |

Инструкция JALR складывает значение в регистре _rs_ с 16-битным смещением,
расширенным знаком, обнуляет 2 нижних бита и записывает значение в _pc_.
В регистр _rd_ записывается адрес следующей инструкции.

### Инструкции условного перехода

| 31                   16 | 15   12 | 11    8 | 7     0 |
|:-----------------------:|:-------:|:-------:|:-------:|
|        off[15:0]        |   rs2   |   rs1   |  opcode |

Все инструкции условного перехода производят сравнение значений
в регистрах _rs1_ и _rs2_ и в зависимости от результата совершают переход.
Адрес перехода получается сложением адреса следующей инструкции
с 16-битным смещением, расширенным знаком и умноженным на 4.

BEQ и BNE производят проверку на равенство и неравенство соответственно.
BLT и BLTU совершают переход, если значение в _rs1_ меньше, чем в _rs2_,
используя знаковое и беззнаковое сравнение.
BGE и BGEU совершают переход, если значение в _rs1_ больше или равно значению
в _rs2_, используя знаковое и беззнаковое сравнение.

## Инструкции чтения и записи памяти

| 31                   16 | 15   12 | 11    8 | 7     0 |
|:-----------------------:|:-------:|:-------:|:-------:|
|        imm[15:0]        |    rb   |  rs/rd  |  opcode |

Инструкции чтения и записи совершают передачу данных между регистрами и памятью.
Адрес в памяти получается сложением значения в регистре _rb_
с 16-битной константой, расширенной знаком.

Инструкции ST.U8, ST.U16 и ST записывают в память 8-битное, 16-битное
и 32-битное значение нижних битов регистра _rs_.

Инструкции LD.S8, LD.S16 и LD загружают в регистр _rd_ 8-битное, 16-битное
и 32-битное значение из памяти, расширенное знаком.

Инструкции LD.U8 и LD.U16 загружают в регистр _rd_ 8-битное
и 16-битное значение из памяти, расширенное нулем.

## Инструкция SYSFN

| 31                           12 | 11    8 | 7     0 |
|:-------------------------------:|:-------:|:-------:|
|             nr[19:0]            |    r    |  opcode |

Инструкция SYSFN совершает вызов системной функции с номером _nr_.

| Номер | Операция                                                                           |
|-------|------------------------------------------------------------------------------------|
| 0     | Завершает выполнение программы.                                                    |
| 1     | Считывает 1 байт, расширенный нулем, в регистр _r_. В случае ошибки записывает -1. |
| 2     | Выводит нижние 8 бит значения в регистре _r_.                                      |

## Таблица кодов инструкций

| Инструкция | opcode[7:0] |
|------------|:-----------:|
| LI         |   10000001  |
| LUI        |   10000010  |
| SYSFN      |   10000011  |
| ST.U8      |   10000100  |
| ST.U16     |   10000101  |
| ST         |   10000110  |
| LD.S8      |   10011000  |
| LD.U8      |   10011100  |
| LD.S16     |   10011001  |
| LD.U16     |   10011101  |
| LD         |   10011010  |
| JAL        |   10100000  |
| JALR       |   10100001  |
| BEQ        |   10100010  |
| BNE        |   10100011  |
| BLT        |   10100100  |
| BGE        |   10100101  |
| BLTU       |   10100110  |
| BGEU       |   10100111  |
| ADDI       |   10001000  |
| RSUBI      |   10001001  |
| MULI       |   10001010  |
| ANDI       |   10010000  |
| ORI        |   10010001  |
| XORI       |   10010010  |
| SHLI       |   10010011  |
| LSHRI      |   10010100  |
| ASHRI      |   10010101  |
| ADD        |   10101000  |
| SUB        |   10101001  |
| MUL        |   10101010  |
| AND        |   10110000  |
| OR         |   10110001  |
| XOR        |   10110010  |
| SHL        |   10110011  |
| LSHR       |   10110100  |
| ASHR       |   10110101  |
| MULW       |   10111000  |
| MULWU      |   10111001  |
| DIV        |   10111010  |
| DIVU       |   10111011  |
